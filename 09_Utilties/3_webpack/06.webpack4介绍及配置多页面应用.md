# webpack 介绍

参考：

[webpack 4: 模式(mode)和优化项(optimization)说明](http://forgetting.me/?p=210)
[webpack4-用之初体验，一起敲它十一遍](https://juejin.im/post/5adea0106fb9a07a9d6ff6de)
[Webpack 4 Tutorial: from 0 Conf to Production Mode](https://www.valentinog.com/blog/webpack-4-tutorial/)

## 基本结构

```js
module.exports = {
  entry: '', // 入口文件
  output: {}, // 出口文件
  module: {}, // 处理不同模块（文件），依赖各种 loader
  plugins: [], // 实现各种功能
  devServer: {}, // 开发服务器配置
  // webpack 根据不同模式做优化（不能过度依赖）
  // 必填，如果不填写，webpack 会 warning
  // mode: 'development',
  optimization: {}, // 提取公共代码等，放在这里
  externals: {}, // ??
  resolve: {}, // 设置别名？？
};
```

`mode` 选项推荐在 npm scripts 中设置，然后 webpack 配置文件氛围 dev 和 pro 两种，如：

```json
"build": "webpack --mode=production",
"dev": "webpack-dev-server --mode=development",
```

## 依赖安装

## webpack 相关：

```bash
yarn add webpack webpack-cli webpack-merge clean-webpack-plugin -D
```

## 样式相关：

```bash
yarn add css-loader style-loader sass-loader node-sass -D
```

- 提取 css

```bash
yarn add mini-css-extract-plugin -D
```

> 注意，`mini-css-extract-plugin` 只适合 webpack4+，同时，为了避免更改 css 引起 js
> chunkhash 的改变，webpack4 之后都建议用 `contenthash` 代替 `hash` 和 `contenthash`了。  
> 参考这两个 issue：
> [Use contenthash over hash and chunkhash for better long term caching](https://github.com/webpack/webpack.js.org/issues/2096),
> [chunkhash changes if style is changed even if style is completely removed by ExtractTextPlugin](https://github.com/webpack/webpack/issues/672)

- 压缩 css

```bash
yarn add optimize-css-assets-webpack-plugin -D
```

> 这个插件只适合 wp4。另外，wb4 如果 mode 是 production 模式，会[自动压缩 js](https://webpack.js.org/configuration/optimization/)，
> 但 css 还需要自己配置。

## js 相关

- babel

```bash
yarn add babel-loader@^8.0.0-beta @babel/core @babel/preset-env
```

上述为 [webpack 4](https://github.com/babel/babel-loader/issues/620)

## 图片相关

- 引入 file-loader
- 只引入 file-loader 还不够，还要引入 html-loader，不然，html 中的图片没法识别。


> 另外，img 不会生成单独的 contenthash，那如何对 image 进行版本控制呢？

## 开发环境

- 配置 devServer

```js
devServer: {
  host: 'localhost',      // 默认是localhost
  port: 3000,             // 默认8080
  open: true,             // 默认 false
  hot: true               // 默认 false（html/css/js任一改动都能实现更新）
}
```

这里有一点要注意：如果 `hot` 没有设置为 `true` 改动代码以后依然可以实现浏览器自动刷新，但是
这里是 **刷新** 而不是热更新，浏览器需要重新渲染。

而热更新的含义是改动哪，浏览器渲染哪，而不是重新请求所有接口全部重新渲染一遍。

除了配置 `devServer`，入口文件要相应加上下面这段代码：

```js
// 配合 webpack 配置实现热更新
if (module.hot) {
  module.hot.accept();
}
```

> 如果 html 的 DOM 元素改变

## 最佳实践

为了更清晰的管理文档，开发配置和生产配置分开写，通过 npm scripts 指定调用哪个，这样的话，
`mode` 选项就可以分别写到开发和生产配置中了。

```js
"build": "webpack --config webpack.pro.js",
"dev": "webpack-dev-server --config webpack.dev.js",
```

通用配置写入 webpack.common.js，避免重复代码，使用 `webpack-merge` 进行合并

> 现在 webpack 有很多默认选项，比如输入输出等，但一般都需要根据项目自己定制。
> 这里写 pro 配置时，忘记写 output 没报错，但多了 bundle.js，默认文件。

- webpack.dev.js

```js
const merge = require('webpack-merge');
const common = require('./webpack.common.js');

module.exports = merge(common, {
  mode: 'development',
});
```

- webpack.pro.js

```js
const merge = require('webpack-merge');
const common = require('./webpack.common.js');

module.exports = merge(common, {
  mode: 'production',
});
```
