# 深入理解函数执行上下文及变量对象

理解函数执行上下文和变量对象之后，才能理解函数执行机制（另写文章专门说下函数传参是按值还是按引用传递）。

## 案例一

```js
function foo(a) {
  console.log(a);

  var a = 2;
  function a() {}
  console.log(a);
}

foo(1); // 1,2
```

上面输出自己写错了，待整理。

上面出错是因为对于函数执行机制了解不深入：**函数被调用，会进入函数调用栈，同时，会有一个对应的执行上下文生成**，执行上下文生命周期分为两个阶段，创建阶段和执行阶段。

> 执行上下文又叫执行环境，包含着函数过程中所需信息，比如，变量对象、作用域链等。

其中，创建阶段会完成下面步骤：创建变量对象、建立作用域链、确定 this 指向；而执行阶段主要完成变量赋值，执行其他代码等。最后处出栈等待回收。

这里的一个重点是创建变量对象的过程：

1. 建立 arguments 对象。检查当前上下文中的参数，建立该对象下的属性和属性值（出了格式化为数组，最后不要直接使用 `arguments` 对参数引用，ES6 之后可以不意义对象）；
2. 检查函数声明，如果属性名已有，覆盖，值为指向函数内存引用的地址；
3. 检查 var 声明，如果属性名已有，忽略（防止函数被赋值为 undefined），不然，添加属性名到变量对象中，值为 undefined。

执行阶段不赘述。

> 注意，执行过程变量对象（variable object）称之为活动对象（active object）。实际，两个对象一样。

所以上面函数执行过程：

```js
function foo(a) {
  // 参数，创建阶段，这里取变量对象，vo 作为名称
  vo.a = 1;

  // 函数提升
  vo.a = function a() {};

  // 变量提升忽略
  // vo.a = undefined; 忽略

  /**
   * 执行阶段，这里去活动对象，ao 作为名称
   */
  console.log(a); // f a() {}

  ao.a = 2;
  console.log(a); // 2
}

foo(1); // 1,2
```

## 案例二

```js
function foo() {
  console.log(a);
  a = 1;
}

foo(); // ???

function bar() {
  a = 1;
  console.log(a);
}
bar(); // ???
```

执行 foo 之所以报错，是因为没有 var 声明的变量，无法在函数上下文创建阶段放入变量对象，所以，访问 a 的时候报错，注意，后面的代码因为抛出错误不会继续执行了，所以 a 不会编程全局变量。

执行 bar 的时候就 ok，这还涉及到函数代码顺序执行的过程。

> 严格模式下 a 不会添加到全局变量中，所以，能严格模式就严格模式，避免不确定或者诡异的执行。

参考：
[前端基础进阶（三）：变量对象详解](https://segmentfault.com/a/1190000012646211)
[JavaScript 深入之变量对象](https://github.com/mqyqingfeng/Blog/blob/master/articles/%E6%B7%B1%E5%85%A5%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/JavaScript%E6%B7%B1%E5%85%A5%E4%B9%8B%E5%8F%98%E9%87%8F%E5%AF%B9%E8%B1%A1.md)
